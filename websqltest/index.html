<!DOCTYPE html>
<html>
	<head>
		<title>Web SQL Database Test</title>
		<script type="text/javascript">
			function dbimport(DB, tableName, tableColumns, tableRows)
			{
				DB.transaction(function (tx) {
					tx.executeSql('DROP TABLE IF EXISTS ' + tableName);
					tx.executeSql('CREATE TABLE ' + tableName + 
								  ' (' + tableColumns.join(',') + ')');
					var q = [];
					for (var i = 0; i < tableColumns.length; i++) {
						q.push('?');
					}
					var query = 'INSERT INTO ' + tableName + ' VALUES (' + q.join(',') + ')';
					for (var i = 0; i < tableRows.length; i++) {
						tx.executeSql(query, tableRows[i]);
					}
				});
			}
			function dataLoaded(DB)
			{
				document.getElementById('message').innerHTML = 'Done!';
				DB.readTransaction(function(tx) {
					tx.executeSql('SELECT name FROM dcm13_venues', [],
						function (tx, result) {
							var venuesDiv = document.getElementById('venues');
							for (var i = 0; i < result.rows.length; i++) {
								var row = result.rows.item(i);
								var elt = document.createElement('DIV');
								elt.innerHTML = row.name;
								venuesDiv.appendChild(elt);
							}
						}
					);
					tx.executeSql('SELECT starttime, dcm13_shows.show_name AS title, dcm13_venues.name AS venue FROM dcm13_schedules JOIN dcm13_shows ON (dcm13_schedules.show_id = dcm13_shows.id) JOIN dcm13_venues ON (dcm13_schedules.venue_id = dcm13_venues.id) ORDER BY starttime', [],
						function (tx, result) {
							var showsDiv = document.getElementById('shows');
							for (var i = 0; i < result.rows.length; i++) {
								var row = result.rows.item(i);
								var t = new Date(row.starttime * 1000);
								var elt = document.createElement('DIV');
								elt.innerHTML = t + ': <b>' + row.title + '</b> at ' + row.venue;
								showsDiv.appendChild(elt);
							}
						}
					);
				});
			}
			function loadCallback(loadFn) {
				var DB = openDatabase('dcm', '1.0', 'Del Close Marathon', 2*1024*1024);
				loadFn(DB);
				dataLoaded(DB);
			}
			window.onload = function() {
				var script = document.createElement('SCRIPT');
				script.type = 'text/javascript';
				script.src = 'dcm13data.js';
				var head = document.getElementsByTagName('HEAD')[0];
				head.appendChild(script);
			}
		</script>
	</head>
	<body>
		<p>This page loads the DCM schedule into a client-side SQL database, then queries it to build a list of shows. It current rewrites the database on every page load, but a smarter version could simply check and only load if the data is already there.</p>
		<p>The <code>dcm13data.js</code> file is generated by the <code>generate-datajs.php</code> script. In production, the JS could be generated live or, better, only when the schedule changes, and saved as a static file.</p>
		<p id="message">Loading...</p>
		<h1>Venues</h1>
		<div id="venues"></div>
		<h1>Shows</h1>
		<div id="shows"></div>
	</body>
</html>
